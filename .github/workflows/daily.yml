name: Auto-Podcast-Daily

on:
  # â‘  JST09:00 â‘¡ JST15:00 â‘¢ JST21:00
  schedule:
    - cron: '0 0  * * *'    # UTC00:00 â†’ JST09:00
    - cron: '0 6  * * *'    # UTC06:00 â†’ JST15:00
    - cron: '0 12 * * *'    # UTC12:00 â†’ JST21:00
    - cron: '0 3  * * *'    # UTC00:00 â†’ JST09:00
    - cron: '0 8  * * *'    # UTC06:00 â†’ JST15:00
    - cron: '0 11 * * *'    # UTC12:00 â†’ JST21:00
  workflow_dispatch:        # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼

concurrency:
  group: auto-podcast-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 540

    steps:
      # â‘  ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      # â‘¡ Python
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # â‘¢ ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
      - name: ğŸ“¦ Install requirements
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: ğŸ”‘ Restore YouTube tokens
        env:
          YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
          YT_ACC2: ${{ secrets.YT_TOKEN_ACC2 }}   # â† æ–°ã—ãè¿½åŠ 
          YT_ACC3: ${{ secrets.YT_TOKEN_ACC3 }}   # â† æ–°ã—ãè¿½åŠ 
          YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}   # â† æ–°ã—ãè¿½åŠ 
          YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
          YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
        run: |
          mkdir -p tokens
          echo "$YT_ACC1" | base64 -d > tokens/token_acc1.pkl
          echo "$YT_ACC2" | base64 -d > tokens/token_acc2.pkl  # â† ã“ã¡ã‚‰ã‚‚è¿½åŠ 
          echo "$YT_ACC3" | base64 -d > tokens/token_acc3.pkl  # â† ã“ã¡ã‚‰ã‚‚è¿½åŠ 
          echo "$YT_ACC4" | base64 -d > tokens/token_acc4.pkl  # â† ã“ã¡ã‚‰ã‚‚è¿½åŠ 
          echo "$YT_ACC5" | base64 -d > tokens/token_acc5.pkl
          echo "$YT_ACC6" | base64 -d > tokens/token_acc6.pkl

      # â‘¤ ãƒˆãƒ”ãƒƒã‚¯æ±ºå®š
      - name: ğŸ“ Pick todayâ€™s topic
        id: topic
        run: |
          echo "topic=$(python topic_picker.py)" >> "$GITHUB_OUTPUT"

      # â‘¥ (æœ€çµ‚) main.py ã‚’ä¸€ç™ºå®Ÿè¡Œã—ã€ã‚³ãƒ³ãƒœã”ã¨ã«å‹•ç”»ç”Ÿæˆï¼†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ¬ Build & Upload All Combos
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          python main.py "${{ steps.topic.outputs.topic }}" \
            --turns 6 \
            --privacy public \
            --chunk 40
