name: Auto-Podcast-Daily

on:
  # â‘  JST09:00 â‘¡ JST15:00 â‘¢ JST21:00
  schedule:
    - cron: '0 0  * * *'    # UTC00:00 â†’ JST09:00
    - cron: '0 6  * * *'    # UTC06:00 â†’ JST15:00
    - cron: '0 12 * * *'    # UTC12:00 â†’ JST21:00
  workflow_dispatch:        # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ concurrency â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: auto-podcast-${{ github.ref }}
  cancel-in-progress: false   # å¤ã„ Run ã‚’æ®ºã•ãªã„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360       # é•·ã‚ã«ç¢ºä¿ï¼ˆçœç•¥å¯ï¼‰

    steps:
    # â‘  ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
    - name: â¬‡ï¸ Checkout repo
      uses: actions/checkout@v4

    # â‘¡ Python
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # â‘¢ ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    - name: ğŸ“¦ Install requirements
      run: |
        sudo apt-get update -y      # FFmpeg
        sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    # â‘£ YouTube OAuth ãƒˆãƒ¼ã‚¯ãƒ³
    - name: ğŸ”‘ Restore YouTube tokens
      env:
        YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
        YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}
        YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
        YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
      run: |
        mkdir -p tokens
        echo "$YT_ACC1" | base64 -d > tokens/token_acc1.pkl
        echo "$YT_ACC4" | base64 -d > tokens/token_acc4.pkl
        echo "$YT_ACC5" | base64 -d > tokens/token_acc5.pkl
        echo "$YT_ACC6" | base64 -d > tokens/token_acc6.pkl

    # â‘¤ ãƒˆãƒ”ãƒƒã‚¯æ±ºå®š
    - name: ğŸ“ Pick todayâ€™s topic
      id: topic
      run: |
        echo "topic=$(python topic_picker.py)" >> "$GITHUB_OUTPUT"

    # â‘¥ å‹•ç”»ç”Ÿæˆ & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    # â‘¥a GPTï¼‹TTSï¼ˆéŸ³å£°ï¼‹lines.json ã¾ã§ï¼å‹•ç”»ã¯ã¾ã ä½œã‚‰ãªã„ï¼‰
    - name: ğŸ—£ï¸ Build script & audio
      env:
        OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
        UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      run: |
        python main.py "${{ steps.topic.outputs.topic }}" \
               --turns 120 --lines-only --privacy private

    # â‘¥b 60ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    - name: âœ‚ï¸ Split & render chunks
      run: |
          python chunk_builder.py temp/lines.json temp/full.mp3 temp/bg.png \
                 --chunk 60 --out output/long_video.mp4


    # â‘¥c å‡ºæ¥ãŸ mp4 ã‚’é †ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: ğŸš€ Upload each mp4
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        for f in output/*.mp4; do
          echo "â–¶ï¸ Upload $f"
          python upload_youtube.py "$f" --privacy public
        done
